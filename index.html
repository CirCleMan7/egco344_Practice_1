<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electricity Usage Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .controls select {
            padding: 12px 20px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .controls select:hover {
            transform: translateY(-2px);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        }

        .chart-card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow-x: auto;
        }

        .table-container h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f5f5f5;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
            }

            .controls select {
                width: 100%;
            }
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚡ Electricity Usage Dashboard</h1>
            <p>Interactive visualization of electricity usage and user data by province</p>
        </div>

        <div class="controls">
            <select id="provinceSelect">
                <option value="">All Provinces</option>
            </select>
        </div>

        <div class="stats-grid" id="statsContainer"></div>

        <div class="charts-grid">
            <div class="chart-card">
                <h2>Usage by Category (All Provinces)</h2>
                <div class="chart-container">
                    <canvas id="usageByCategory"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2>Top 10 Provinces by Total Usage</h2>
                <div class="chart-container">
                    <canvas id="topProvinces"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2>Users by Category (All Provinces)</h2>
                <div class="chart-container">
                    <canvas id="usersByCategory"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2>Province Comparison</h2>
                <div class="chart-container">
                    <canvas id="provinceComparison"></canvas>
                </div>
            </div>

            <div class="chart-card full-width">
                <h2>Usage Distribution by Province</h2>
                <div class="chart-container" style="height: 500px;">
                    <canvas id="provinceDistribution"></canvas>
                </div>
            </div>
        </div>

        <div class="table-container">
            <h2>Detailed Data Table</h2>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Province</th>
                        <th>Total Usage (kWh)</th>
                        <th>Total Users</th>
                        <th>Avg per User (kWh)</th>
                        <th>Year</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let usageData = [];
        let usersData = [];
        let charts = {};

        // Fetch data
        async function loadData() {
            try {
                const usageResponse = await fetch('electricity_usages_en.json');
                if (!usageResponse.ok) {
                    throw new Error(`Failed to fetch electricity_usages_en.json: ${usageResponse.status}`);
                }
                const usageJson = await usageResponse.json();
                usageData = usageJson.Sheet1 || [];
                
                if (!usageData || usageData.length === 0) {
                    throw new Error('No data found in electricity_usages_en.json');
                }

                const usersResponse = await fetch('electricity_users_en.json');
                if (!usersResponse.ok) {
                    throw new Error(`Failed to fetch electricity_users_en.json: ${usersResponse.status}`);
                }
                usersData = await usersResponse.json();
                
                if (!usersData || usersData.length === 0) {
                    throw new Error('No data found in electricity_users_en.json');
                }

                initializeApp();
            } catch (error) {
                console.error('Error loading data:', error);
                document.body.innerHTML = '<div class="loading" style="padding: 40px; color: #333; background: white; margin: 20px; border-radius: 10px;"><h2>⚠️ Error loading data</h2><p>Error: ' + error.message + '</p><p>Please make sure the JSON files are in the same directory as this HTML file.</p></div>';
            }
        }

        function initializeApp() {
            populateProvinceSelect();
            updateCharts();
            updateTable();
            document.getElementById('provinceSelect').addEventListener('change', updateCharts);
        }

        function populateProvinceSelect() {
            const provinces = [...new Set(usageData.map(d => d.province_name))].sort();
            const select = document.getElementById('provinceSelect');
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                select.appendChild(option);
            });
        }

        function getSelectedProvince() {
            return document.getElementById('provinceSelect').value;
        }

        function filterData(data, province) {
            return province ? data.filter(d => d.province_name === province) : data;
        }

        function updateStats() {
            const selectedProvince = getSelectedProvince();
            const filteredUsage = filterData(usageData, selectedProvince);
            const filteredUsers = filterData(usersData, selectedProvince);

            let totalUsage = 0;
            let totalUsers = 0;

            filteredUsage.forEach(d => {
                totalUsage += Object.values(d).filter(v => typeof v === 'number' && !isNaN(v) && 
                    String(d).includes('kwh')).reduce((a, b) => a + b, 0);
                // Calculate more accurately
                const categories = Object.keys(d).filter(k => k.includes('_kwh'));
                totalUsage += categories.reduce((sum, cat) => sum + (d[cat] || 0), 0);
            });

            filteredUsers.forEach(d => {
                const categories = Object.keys(d).filter(k => k.includes('_count'));
                totalUsers += categories.reduce((sum, cat) => sum + (d[cat] || 0), 0);
            });

            const statsHTML = `
                <div class="stat-card">
                    <h3>Total Usage</h3>
                    <div class="stat-value">${(totalUsage / 1e9).toFixed(2)}B kWh</div>
                </div>
                <div class="stat-card">
                    <h3>Total Users</h3>
                    <div class="stat-value">${(totalUsers / 1e6).toFixed(2)}M</div>
                </div>
                <div class="stat-card">
                    <h3>Provinces</h3>
                    <div class="stat-value">${[...new Set(usageData.map(d => d.province_name))].length}</div>
                </div>
                <div class="stat-card">
                    <h3>Avg per User</h3>
                    <div class="stat-value">${totalUsers > 0 ? (totalUsage / totalUsers).toFixed(0) : 0} kWh</div>
                </div>
            `;
            document.getElementById('statsContainer').innerHTML = statsHTML;
        }

        function updateCharts() {
            const selectedProvince = getSelectedProvince();
            updateStats();
            createUsageByCategory(selectedProvince);
            createTopProvinces();
            createUsersByCategory(selectedProvince);
            createProvinceComparison(selectedProvince);
            createProvinceDistribution();
        }

        function createUsageByCategory(province) {
            const data = filterData(usageData, province);
            const categories = [
                'residential_kwh', 'small_business_kwh', 'medium_business_kwh',
                'large_business_kwh', 'specialized_business_kwh', 'public_electricity_kwh',
                'government_state_enterprise_kwh', 'ev_charging_kwh'
            ];

            const categoryLabels = [
                'Residential', 'Small Business', 'Medium Business',
                'Large Business', 'Specialized', 'Public', 'Gov/Enterprise', 'EV Charging'
            ];

            const totals = categories.map(cat => 
                data.reduce((sum, d) => sum + (d[cat] || 0), 0)
            );

            const ctx = document.getElementById('usageByCategory').getContext('2d');
            if (charts.usageByCategory) charts.usageByCategory.destroy();

            charts.usageByCategory = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: totals,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    return context.label + ': ' + (value / 1e9).toFixed(2) + 'B kWh';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTopProvinces() {
            const provinceUsage = {};
            usageData.forEach(d => {
                if (!provinceUsage[d.province_name]) {
                    provinceUsage[d.province_name] = 0;
                }
                Object.keys(d).filter(k => k.includes('_kwh')).forEach(cat => {
                    provinceUsage[d.province_name] += d[cat] || 0;
                });
            });

            const sorted = Object.entries(provinceUsage)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx = document.getElementById('topProvinces').getContext('2d');
            if (charts.topProvinces) charts.topProvinces.destroy();

            charts.topProvinces = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(d => d[0]),
                    datasets: [{
                        label: 'Total Usage (kWh)',
                        data: sorted.map(d => d[1] / 1e9),
                        backgroundColor: '#36A2EB',
                        borderColor: '#2E86DE',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            title: { display: true, text: 'Usage (Billion kWh)' }
                        }
                    }
                }
            });
        }

        function createUsersByCategory(province) {
            const data = filterData(usersData, province);
            const categories = [
                'residential_count', 'small_business_count', 'medium_business_count',
                'large_business_count', 'specialized_business_count', 'public_electricity_count',
                'government_state_enterprise_count', 'ev_charging_count'
            ];

            const categoryLabels = [
                'Residential', 'Small Business', 'Medium Business',
                'Large Business', 'Specialized', 'Public', 'Gov/Enterprise', 'EV Charging'
            ];

            const totals = categories.map(cat => 
                data.reduce((sum, d) => sum + (d[cat] || 0), 0)
            );

            const ctx = document.getElementById('usersByCategory').getContext('2d');
            if (charts.usersByCategory) charts.usersByCategory.destroy();

            charts.usersByCategory = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: 'Number of Users',
                        data: totals,
                        backgroundColor: '#4BC0C0',
                        borderColor: '#2AA8A8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            title: { display: true, text: 'Number of Users' }
                        }
                    }
                }
            });
        }

        function createProvinceComparison(province) {
            if (!province) {
                // Show all provinces in comparison
                const provinces = [...new Set(usageData.map(d => d.province_name))].sort().slice(0, 15);
                const usageByProvince = provinces.map(p => {
                    const data = filterData(usageData, p);
                    return data.reduce((sum, d) => {
                        return sum + Object.keys(d).filter(k => k.includes('_kwh'))
                            .reduce((s, cat) => s + (d[cat] || 0), 0);
                    }, 0);
                });

                const ctx = document.getElementById('provinceComparison').getContext('2d');
                if (charts.provinceComparison) charts.provinceComparison.destroy();

                charts.provinceComparison = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: provinces,
                        datasets: [{
                            label: 'Total Usage (kWh)',
                            data: usageByProvince.map(d => d / 1e9),
                            backgroundColor: '#FF9F40',
                            borderColor: '#E67E22',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }
                        }
                    }
                });
            }
        }

        function createProvinceDistribution() {
            const provinceUsage = {};
            const provinceUsers = {};

            usageData.forEach(d => {
                if (!provinceUsage[d.province_name]) {
                    provinceUsage[d.province_name] = 0;
                }
                Object.keys(d).filter(k => k.includes('_kwh')).forEach(cat => {
                    provinceUsage[d.province_name] += d[cat] || 0;
                });
            });

            usersData.forEach(d => {
                if (!provinceUsers[d.province_name]) {
                    provinceUsers[d.province_name] = 0;
                }
                Object.keys(d).filter(k => k.includes('_count')).forEach(cat => {
                    provinceUsers[d.province_name] += d[cat] || 0;
                });
            });

            const provinces = Object.keys(provinceUsage).sort();
            const usages = provinces.map(p => provinceUsage[p] / 1e9);
            const users = provinces.map(p => provinceUsers[p] / 1e6);

            const ctx = document.getElementById('provinceDistribution').getContext('2d');
            if (charts.provinceDistribution) charts.provinceDistribution.destroy();

            charts.provinceDistribution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: provinces,
                    datasets: [
                        {
                            label: 'Usage (B kWh)',
                            data: usages,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Users (M)',
                            data: users,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            ticks: { maxRotation: 45, minRotation: 45 }
                        },
                        y: {
                            title: { display: true, text: 'Usage (B kWh)' },
                            position: 'left'
                        },
                        y1: {
                            title: { display: true, text: 'Users (M)' },
                            position: 'right',
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function updateTable() {
            const selectedProvince = getSelectedProvince();
            const filteredUsage = filterData(usageData, selectedProvince);
            const filteredUsers = filterData(usersData, selectedProvince);

            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            const provinceData = {};
            filteredUsage.forEach(d => {
                if (!provinceData[d.province_name]) {
                    provinceData[d.province_name] = { usage: 0, users: 0, year: d.year };
                }
                Object.keys(d).filter(k => k.includes('_kwh')).forEach(cat => {
                    provinceData[d.province_name].usage += d[cat] || 0;
                });
            });

            filteredUsers.forEach(d => {
                if (provinceData[d.province_name]) {
                    Object.keys(d).filter(k => k.includes('_count')).forEach(cat => {
                        provinceData[d.province_name].users += d[cat] || 0;
                    });
                }
            });

            Object.entries(provinceData)
                .sort((a, b) => b[1].usage - a[1].usage)
                .forEach(([province, data]) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${province}</td>
                        <td>${(data.usage / 1e9).toFixed(3)}B</td>
                        <td>${(data.users / 1e6).toFixed(3)}M</td>
                        <td>${data.users > 0 ? (data.usage / data.users).toFixed(0) : 0}</td>
                        <td>${data.year}</td>
                    `;
                });
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
