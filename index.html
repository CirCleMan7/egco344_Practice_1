<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electricity Usage Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 32px;
            background: white;
            padding: 32px 24px;
            border-radius: 12px;
            border-bottom: 2px solid #e5e5e5;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            font-size: 0.95em;
            color: #666;
            margin: 0;
        }

        .controls {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .controls select {
            padding: 10px 16px;
            font-size: 0.95em;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .controls select:hover {
            border-color: #999;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.3s;
        }

        .chart-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .chart-card h2 {
            color: #1a1a1a;
            margin-bottom: 16px;
            font-size: 1.25em;
            font-weight: 600;
            border-bottom: 2px solid #e5e5e5;
            padding-bottom: 12px;
        }

        .chart-container {
            position: relative;
            height: 380px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border-left: 3px solid #5a67d8;
        }

        .stat-card h3 {
            color: #999;
            font-size: 0.8em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.75em;
            font-weight: 700;
            color: #5a67d8;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow-x: auto;
        }

        .table-container h2 {
            color: #1a1a1a;
            margin-bottom: 16px;
            font-size: 1.25em;
            font-weight: 600;
            border-bottom: 2px solid #e5e5e5;
            padding-bottom: 12px;
        }

        .search-box {
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #5a67d8;
            box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.1);
        }

        .search-box button {
            padding: 10px 20px;
            background: #5a67d8;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .search-box button:hover {
            background: #4c51bf;
        }

        .search-results {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            color: #1a1a1a;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            border-bottom: 2px solid #e5e5e5;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #555;
        }

        tr:hover {
            background: #fafafa;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .controls {
                flex-direction: column;
            }

            .controls select {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .loading {
            text-align: center;
            color: #333;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚡ Electricity Usage Dashboard</h1>
            <p>Interactive visualization of electricity usage and user data by province</p>
        </div>

        <div class="controls">
            <select id="provinceSelect">
                <option value="">All Provinces</option>
            </select>
        </div>

        <div class="stats-grid" id="statsContainer"></div>

        <div class="charts-grid">
            <div class="chart-card">
                <h2>Usage by Category (All Provinces)</h2>
                <div class="chart-container">
                    <canvas id="usageByCategory"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2>Top 10 Provinces by Total Usage</h2>
                <div class="chart-container">
                    <canvas id="topProvinces"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2>Users by Category (All Provinces)</h2>
                <div class="chart-container">
                    <canvas id="usersByCategory"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2>Province Comparison</h2>
                <div class="chart-container">
                    <canvas id="provinceComparison"></canvas>
                </div>
            </div>

            <div class="chart-card full-width">
                <h2>Usage Distribution by Province</h2>
                <div class="chart-container" style="height: 500px;">
                    <canvas id="provinceDistribution"></canvas>
                </div>
            </div>
        </div>

        <div class="table-container">
            <h2>Detailed Data Table</h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by province name...">
                <button onclick="clearSearch()">Clear</button>
            </div>
            <div class="search-results" id="searchResults"></div>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Province</th>
                        <th>Total Usage (kWh)</th>
                        <th>Total Users</th>
                        <th>Avg per User (kWh)</th>
                        <th>Year</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let usageData = [];
        let usersData = [];
        let charts = {};

        // Fetch data
        async function loadData() {
            try {
                const usageResponse = await fetch('electricity_usages_en.json');
                if (!usageResponse.ok) {
                    throw new Error(`Failed to fetch electricity_usages_en.json: ${usageResponse.status}`);
                }
                const usageJson = await usageResponse.json();
                usageData = usageJson.Sheet1 || [];
                
                if (!usageData || usageData.length === 0) {
                    throw new Error('No data found in electricity_usages_en.json');
                }

                const usersResponse = await fetch('electricity_users_en.json');
                if (!usersResponse.ok) {
                    throw new Error(`Failed to fetch electricity_users_en.json: ${usersResponse.status}`);
                }
                usersData = await usersResponse.json();
                
                if (!usersData || usersData.length === 0) {
                    throw new Error('No data found in electricity_users_en.json');
                }

                initializeApp();
            } catch (error) {
                console.error('Error loading data:', error);
                document.body.innerHTML = '<div class="loading" style="padding: 40px; color: #333; background: white; margin: 20px; border-radius: 10px;"><h2>⚠️ Error loading data</h2><p>Error: ' + error.message + '</p><p>Please make sure the JSON files are in the same directory as this HTML file.</p></div>';
            }
        }

        function initializeApp() {
            populateProvinceSelect();
            updateCharts();
            updateTable();
            document.getElementById('provinceSelect').addEventListener('change', updateCharts);
        }

        function populateProvinceSelect() {
            const provinces = [...new Set(usageData.map(d => d.province_name))].sort();
            const select = document.getElementById('provinceSelect');
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                select.appendChild(option);
            });
        }

        function getSelectedProvince() {
            return document.getElementById('provinceSelect').value;
        }

        function filterData(data, province) {
            return province ? data.filter(d => d.province_name === province) : data;
        }

        function updateStats() {
            const selectedProvince = getSelectedProvince();
            const filteredUsage = filterData(usageData, selectedProvince);
            const filteredUsers = filterData(usersData, selectedProvince);

            let totalUsage = 0;
            let totalUsers = 0;

            filteredUsage.forEach(d => {
                totalUsage += Object.values(d).filter(v => typeof v === 'number' && !isNaN(v) && 
                    String(d).includes('kwh')).reduce((a, b) => a + b, 0);
                // Calculate more accurately
                const categories = Object.keys(d).filter(k => k.includes('_kwh'));
                totalUsage += categories.reduce((sum, cat) => sum + (d[cat] || 0), 0);
            });

            filteredUsers.forEach(d => {
                const categories = Object.keys(d).filter(k => k.includes('_count'));
                totalUsers += categories.reduce((sum, cat) => sum + (d[cat] || 0), 0);
            });

            const statsHTML = `
                <div class="stat-card">
                    <h3>Total Usage</h3>
                    <div class="stat-value">${(totalUsage / 1e9).toFixed(2)}B kWh</div>
                </div>
                <div class="stat-card">
                    <h3>Total Users</h3>
                    <div class="stat-value">${(totalUsers / 1e6).toFixed(2)}M</div>
                </div>
                <div class="stat-card">
                    <h3>Provinces</h3>
                    <div class="stat-value">${[...new Set(usageData.map(d => d.province_name))].length}</div>
                </div>
                <div class="stat-card">
                    <h3>Avg per User</h3>
                    <div class="stat-value">${totalUsers > 0 ? (totalUsage / totalUsers).toFixed(0) : 0} kWh</div>
                </div>
            `;
            document.getElementById('statsContainer').innerHTML = statsHTML;
        }

        function updateCharts() {
            const selectedProvince = getSelectedProvince();
            updateStats();
            createUsageByCategory(selectedProvince);
            createTopProvinces();
            createUsersByCategory(selectedProvince);
            createProvinceComparison(selectedProvince);
            createProvinceDistribution();
        }

        function createUsageByCategory(province) {
            const data = filterData(usageData, province);
            const categories = [
                'residential_kwh', 'small_business_kwh', 'medium_business_kwh',
                'large_business_kwh', 'specialized_business_kwh', 'public_electricity_kwh',
                'government_state_enterprise_kwh', 'ev_charging_kwh'
            ];

            const categoryLabels = [
                'Residential', 'Small Business', 'Medium Business',
                'Large Business', 'Specialized', 'Public', 'Gov/Enterprise', 'EV Charging'
            ];

            const totals = categories.map(cat => 
                data.reduce((sum, d) => sum + (d[cat] || 0), 0)
            );

            const ctx = document.getElementById('usageByCategory').getContext('2d');
            if (charts.usageByCategory) charts.usageByCategory.destroy();

            charts.usageByCategory = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: totals,
                        backgroundColor: [
                            '#5a67d8', '#f56565', '#48bb78', '#ed8936',
                            '#9f7aea', '#38b2ac', '#ecc94b', '#ed64a6'
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    return context.label + ': ' + (value / 1e9).toFixed(2) + 'B kWh';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTopProvinces() {
            const provinceUsage = {};
            usageData.forEach(d => {
                if (!provinceUsage[d.province_name]) {
                    provinceUsage[d.province_name] = 0;
                }
                Object.keys(d).filter(k => k.includes('_kwh')).forEach(cat => {
                    provinceUsage[d.province_name] += d[cat] || 0;
                });
            });

            const sorted = Object.entries(provinceUsage)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx = document.getElementById('topProvinces').getContext('2d');
            if (charts.topProvinces) charts.topProvinces.destroy();

            charts.topProvinces = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(d => d[0]),
                    datasets: [{
                        label: 'Total Usage (kWh)',
                        data: sorted.map(d => d[1] / 1e9),
                        backgroundColor: '#5a67d8',
                        borderColor: '#4c51bf',
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            title: { display: true, text: 'Usage (Billion kWh)' }
                        }
                    }
                }
            });
        }

        function createUsersByCategory(province) {
            const data = filterData(usersData, province);
            const categories = [
                'residential_count', 'small_business_count', 'medium_business_count',
                'large_business_count', 'specialized_business_count', 'public_electricity_count',
                'government_state_enterprise_count', 'ev_charging_count'
            ];

            const categoryLabels = [
                'Residential', 'Small Business', 'Medium Business',
                'Large Business', 'Specialized', 'Public', 'Gov/Enterprise', 'EV Charging'
            ];

            const totals = categories.map(cat => 
                data.reduce((sum, d) => sum + (d[cat] || 0), 0)
            );

            // Create array of {label, value} and sort
            const sorted = categoryLabels.map((label, index) => ({
                label: label,
                value: totals[index]
            })).sort((a, b) => b.value - a.value);

            const sortedLabels = sorted.map(item => item.label);
            const sortedValues = sorted.map(item => item.value);

            const ctx = document.getElementById('usersByCategory').getContext('2d');
            if (charts.usersByCategory) charts.usersByCategory.destroy();

            charts.usersByCategory = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedLabels,
                    datasets: [{
                        label: 'Number of Users',
                        data: sortedValues,
                        backgroundColor: '#f56565',
                        borderColor: '#e53e3e',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            title: { display: true, text: 'Number of Users' }
                        }
                    }
                }
            });
        }

        function createProvinceComparison(province) {
            if (!province) {
                // Show all provinces in comparison
                const provinces = [...new Set(usageData.map(d => d.province_name))].sort();
                const usageByProvince = provinces.map(p => {
                    const data = filterData(usageData, p);
                    return data.reduce((sum, d) => {
                        return sum + Object.keys(d).filter(k => k.includes('_kwh'))
                            .reduce((s, cat) => s + (d[cat] || 0), 0);
                    }, 0);
                });

                // Create array of {province, usage} and sort high to low
                const sorted = provinces.map((prov, index) => ({
                    province: prov,
                    usage: usageByProvince[index]
                })).sort((a, b) => b.usage - a.usage);

                const sortedProvinces = sorted.map(item => item.province);
                const sortedUsages = sorted.map(item => item.usage / 1e9);

                const ctx = document.getElementById('provinceComparison').getContext('2d');
                if (charts.provinceComparison) charts.provinceComparison.destroy();

                charts.provinceComparison = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedProvinces,
                        datasets: [{
                            label: 'Total Usage (kWh)',
                            data: sortedUsages,
                            backgroundColor: '#48bb78',
                            borderColor: '#38a169',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }
                        }
                    }
                });
            }
        }

        function createProvinceDistribution() {
            const provinceUsage = {};
            const provinceUsers = {};

            usageData.forEach(d => {
                if (!provinceUsage[d.province_name]) {
                    provinceUsage[d.province_name] = 0;
                }
                Object.keys(d).filter(k => k.includes('_kwh')).forEach(cat => {
                    provinceUsage[d.province_name] += d[cat] || 0;
                });
            });

            usersData.forEach(d => {
                if (!provinceUsers[d.province_name]) {
                    provinceUsers[d.province_name] = 0;
                }
                Object.keys(d).filter(k => k.includes('_count')).forEach(cat => {
                    provinceUsers[d.province_name] += d[cat] || 0;
                });
            });

            const provinces = Object.keys(provinceUsage).sort();
            const usages = provinces.map(p => provinceUsage[p] / 1e9);
            const users = provinces.map(p => provinceUsers[p] / 1e6);

            const ctx = document.getElementById('provinceDistribution').getContext('2d');
            if (charts.provinceDistribution) charts.provinceDistribution.destroy();

            charts.provinceDistribution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: provinces,
                    datasets: [
                        {
                            label: 'Usage (B kWh)',
                            data: usages,
                            borderColor: '#5a67d8',
                            backgroundColor: 'rgba(90, 103, 216, 0.08)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y',
                            borderWidth: 2
                        },
                        {
                            label: 'Users (M)',
                            data: users,
                            borderColor: '#f56565',
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y1',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            ticks: { maxRotation: 45, minRotation: 45 }
                        },
                        y: {
                            title: { display: true, text: 'Usage (B kWh)' },
                            position: 'left'
                        },
                        y1: {
                            title: { display: true, text: 'Users (M)' },
                            position: 'right',
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function updateTable() {
            const selectedProvince = getSelectedProvince();
            const filteredUsage = filterData(usageData, selectedProvince);
            const filteredUsers = filterData(usersData, selectedProvince);

            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            const provinceData = {};
            filteredUsage.forEach(d => {
                if (!provinceData[d.province_name]) {
                    provinceData[d.province_name] = { usage: 0, users: 0, year: d.year };
                }
                Object.keys(d).filter(k => k.includes('_kwh')).forEach(cat => {
                    provinceData[d.province_name].usage += d[cat] || 0;
                });
            });

            filteredUsers.forEach(d => {
                if (provinceData[d.province_name]) {
                    Object.keys(d).filter(k => k.includes('_count')).forEach(cat => {
                        provinceData[d.province_name].users += d[cat] || 0;
                    });
                }
            });

            window.tableDataArray = Object.entries(provinceData)
                .sort((a, b) => b[1].usage - a[1].usage)
                .map(([province, data]) => ({
                    province,
                    usage: data.usage,
                    users: data.users,
                    year: data.year
                }));

            renderTableRows(window.tableDataArray);
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').textContent = '';
        }

        function renderTableRows(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.province}</td>
                    <td>${(item.usage / 1e9).toFixed(3)}B</td>
                    <td>${(item.users / 1e6).toFixed(3)}M</td>
                    <td>${item.users > 0 ? (item.usage / item.users).toFixed(0) : 0}</td>
                    <td>${item.year}</td>
                `;
            });
        }

        function searchTable() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchValue) {
                renderTableRows(window.tableDataArray);
                document.getElementById('searchResults').textContent = '';
                return;
            }

            const filtered = window.tableDataArray.filter(item => 
                item.province.toLowerCase().includes(searchValue)
            );

            renderTableRows(filtered);
            document.getElementById('searchResults').textContent = `Found ${filtered.length} result(s)`;
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').textContent = '';
            renderTableRows(window.tableDataArray);
        }

        // Add event listener for real-time search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keyup', searchTable);
            }
        });

        // Load data on page load
        loadData();
    </script>
</body>
</html>
